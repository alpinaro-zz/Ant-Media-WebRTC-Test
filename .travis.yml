dist: focal
language: java
jdk:
  - openjdk11
node_js: "14.8.0"

git:
  depth: false

# Sonar cloud addons on travis has some issues so that it's used directly 
addons:
  sonarcloud:
    organization: "ant-media"
    token: $SONAR_TOKEN





install:
  - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -Dgpg.skip=true -B -V --quiet

before_script:
  - sudo chmod -R 777 /tmp


script:
  - export RELEASE_VERSION="$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)"
  - echo $RELEASE_VERSION
  - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent package  org.jacoco:jacoco-maven-plugin:report sonar:sonar -Dmaven.javadoc.skip=true --quiet
  # option to add above (-Dtest="MuxerUnitTest")  for running custom tests
  - mvn org.owasp:dependency-check-maven:check --quiet
#depedency vulnerability check


cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.sonar/cache'

after_failure:
  - sudo cat /usr/local/antmedia/log/ant-media-server.log
  - sudo service mongod status
  - sudo cat /var/log/mongodb/mongod.log
  - sudo cat /usr/local/antmedia/hs_err_pid*.log  # cat hs_err_pid file if it exists
  - sudo cat hs_err_pid*.log  # cat hs_err_pid file if it exists


deploy:
  - provider: script
    script: "mvn deploy -P assemble -DskipTests --settings mvn-settings.xml --quiet"
    skip_cleanup: true
    on:
      tags: false
      all_branches: true
      #deploy all branches to mvn if it is a snapshot version
      condition:  $(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)  = *"SNAPSHOT"*

  - provider: script
    script: "mvn deploy -P assemble -DskipTests --settings mvn-settings.xml --quiet"
    skip_cleanup: true
    on:
      #deploy to maven if it is a release tagged
      tags: true
      condition: $TRAVIS_TAG =~ ^ams-v 